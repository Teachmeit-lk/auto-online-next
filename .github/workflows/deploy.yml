name: Build and Deploy to Server

on:
  pull_request:
    types:
      - closed
    branches:
      - develop
  push:
    branches:
      - develop

jobs:
  # 1. BUILD JOB
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Install sharp and optional dependencies
        run: npm install --include=optional sharp

      - name: Create production env file
        run: |
          echo "NODE_ENV=production" > .env.production
          echo "NEXT_PUBLIC_APP_URL=http://autoonline.teachmeit.lk" >> .env.production
          echo "PORT=4001" >> .env.production

      - name: Build Next.js project
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            .
            !node_modules
          include-hidden-files: true
          retention-days: 1

  # 2. DEPLOY JOB
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: .

      - name: Copy project files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/var/www/auto-online-next-tmp"
          overwrite: true
          rm: true

      - name: Deploy on server (using systemd)
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Move to proper directory (create if doesn't exist)
            sudo mkdir -p /var/www/auto-online-next
            sudo rm -rf /var/www/auto-online-next/*
            sudo cp -r /var/www/auto-online-next-tmp/* /var/www/auto-online-next/
            sudo rm -rf /var/www/auto-online-next-tmp
            cd /var/www/auto-online-next

            # Debug: List contents including hidden files
            echo "Listing all files (including hidden):"
            ls -la

            # Check for .next directory
            if [ ! -d ".next" ]; then
              echo "WARNING: .next directory is missing! Attempting to rebuild..."
              
              # Install all dependencies (including dev dependencies) to enable rebuilding
              npm ci
              
              # Recreate environment file if needed
              if [ ! -f .env.production ]; then
                echo "Creating .env.production file"
                echo "NODE_ENV=production" > .env.production
                echo "NEXT_PUBLIC_APP_URL=http://autoonline.teachmeit.lk" >> .env.production
                echo "PORT=4001" >> .env.production
              fi
              
              # Rebuild the application
              npm run build
            else
              echo ".next directory exists"
            fi

            # Set proper ownership and permissions
            sudo chown -R $(whoami):$(whoami) /var/www/auto-online-next
            sudo chmod -R 755 .next 2>/dev/null || echo "No .next directory to chmod"

            # Install production dependencies
            npm ci --production

            # Update NGINX configuration with buffer settings
            echo "Updating NGINX configuration with proper buffer settings..."
            sudo tee /etc/nginx/sites-available/autoonline.teachmeit.lk > /dev/null << EOT
          server {
            listen 80;
            server_name autoonline.teachmeit.lk;

            location / {
              proxy_pass http://localhost:4001;
              proxy_http_version 1.1;
              proxy_set_header Upgrade \$http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host \$host;
              proxy_cache_bypass \$http_upgrade;
              
              # Add buffer settings to fix 502 errors
              proxy_buffer_size 128k;
              proxy_buffers 4 256k;
              proxy_busy_buffers_size 256k;
              
              # Add timeout settings
              proxy_connect_timeout 300;
              proxy_read_timeout 300;
              proxy_send_timeout 300;
            }
          }
          EOT

            # Verify NGINX config
            sudo nginx -t

            # Update systemd service for better reliability
            echo "Updating systemd service for Next.js..."
            sudo tee /etc/systemd/system/autoonline.service > /dev/null << EOT
          [Unit]
          Description=Auto Online Next.js Application
          After=network.target

          [Service]
          Environment=NODE_ENV=production
          Type=simple
          User=$(whoami)
          WorkingDirectory=/var/www/auto-online-next
          ExecStart=$(which node) /var/www/auto-online-next/node_modules/.bin/next start -p 4001
          Restart=always
          RestartSec=10
          StandardOutput=syslog
          StandardError=syslog
          SyslogIdentifier=autoonline

          [Install]
          WantedBy=multi-user.target
          EOT

            # Kill any process still using port 4001
            sudo fuser -k 4001/tcp || true

            # Reload systemd
            sudo systemctl daemon-reload

            # Start service
            sudo systemctl restart autoonline.service
            
            # Enable on boot
            sudo systemctl enable autoonline.service

            # Check service status
            sudo systemctl status autoonline.service --no-pager

            # Reload NGINX
            sudo systemctl reload nginx

            # Verify the app is running
            echo "Testing application response:"
            curl -I http://localhost:4001 || echo "ERROR: Application not responding locally!"

            echo "Deployment completed at $(date)"

  # # 3. NOTIFICATION JOB
  # notify:
  #   needs: [build, deploy]
  #   runs-on: ubuntu-latest
  #   if: always()
  #   steps:
  #     - name: Send deployment notification
  #       uses: slackapi/slack-github-action@v1.25.0
  #       with:
  #         payload: |
  #           {
  #             "text": "Auto-Online-Next Deployment Status",
  #             "blocks": [
  #               {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": "${{ needs.deploy.result == 'success' && '*Deployment Successful* :white_check_mark:' || '*Deployment Failed* :x:' }}\n• *Project:* Auto-Online-Next\n• *Branch:* develop\n• *Status:* ${{ needs.deploy.result == 'success' && 'Success ✅' || 'Failed ❌' }}\n• *Web Application URL:* http://autoonline.teachmeit.lk/"
  #                 }
  #               },                {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": "${{ needs.deploy.result == 'success' && 'Application has been deployed and is now running.' || format('Please check the <{0}/{1}/actions/runs/{2}|workflow run> for details.', github.server_url, github.repository, github.run_id) }}"
  #                 }
  #               }
  #             ]
  #           }
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  #         SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
